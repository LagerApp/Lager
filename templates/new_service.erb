<div class="content">
  <div style="padding: 10px;" id="serverSelector">
    <button id="confirmServersButton" class="btn btn-positive btn-block next-step" disabled="true">Next step</button>
  </div>

  <form id="serviceSelector" style="padding: 10px; display: none;">
    <div>
      <h6>Selected servers to log on:<h6>
      <ul id="selectedServers" class="table-view">
      </ul>
    </div>
    <hr />
    <select>
      <option selected="selected" disabled="disabled">- Select a service -</option>
    </select>
    <input id="serviceNameInput" type="text" placeholder='Label (e.g. app1-nyc, mysql1-sg)'></input>
    <input id="logPathInput" type="text" placeholder='Log filepath (e.g. /var/log/svc.log)'></input>
    <button id="confirmServiceButton" class="btn btn-positive btn-block" type="submit" disabled="true">Confirm</button>
  </form>

  <script class="load-on-push" type="text/javascript">

$("#right-nav-button").hide();

$('header .title').text('Select server to log');

// Dummy data to be replaced by Ajax call
var serviceData = [
  {
    name: 'nginx',
    service_type: 'nginx',
    default_log: '/var/log/nginx'
  },
  {
    name: 'apache2',
    service_type: 'apache2',
    default_log: '/var/log/apache2'
  },
  {
    name: 'mysql',
    service_type: 'mysql',
    default_log: '/var/log/mysql'
  },
  {
    name: 'postgresql',
    service_type: 'postgresql',
    default_log: '/var/log/pg'
  },
  {
    name: 'Others',
    service_type: 'Others',
    default_log: ''
  }
];

// Stores the form data
var formData = {
  services: {
    servers: [],
    name: '',
    service_type: '',
    log_path: ''
  }
};

/*
$.get("/servers", function(resp) {
  // Populate the server selectors
  resp.forEach(function(server) {
    $('#serverSelector .next-step').before('<button class="btn btn-block btn-outlined">' + server.host + '</button>');
  });
  prepareServerButtons();
})
*/

JSON.parse(sessionStorage.getItem('servers')).forEach(function(server) {
  $('#serverSelector .next-step').before('<button class="btn btn-block btn-outlined">' + server.host + '</button>');
});
prepareServerButtons();

// Turns button into active on touch and stores server selection into form data
function prepareServerButtons() {
  $('button.btn-outlined').on('click', function() {
    var selectedServer = $(this).text();
    $(this).toggleClass('active');

    var i = formData.services.servers.indexOf(selectedServer);
    if (i === -1) {
      formData.services.servers.push(selectedServer);
    } else {
      formData.services.servers.splice(i, 1);
    }

    $("#confirmServersButton").attr({ disabled: (formData.services.servers.length == 0) })
});

}
// Populate the service selector
serviceData.forEach(function(service) {
  var newEl = $('<option class="btn btn-positive btn-block btn-outlined">' + service.service_type + '</option>');
  $('#serviceSelector select').append(newEl);
});

// Populate the service log path
$('#serviceSelector select').on('change', function() {
  $("#confirmServiceButton").attr({ disabled: false })
  var selectedService = $('#serviceSelector select').val();
  var selectedServiceLogPath = serviceData.filter(function(service) {
    return service.service_type === selectedService;
  });
  $('#logPathInput').val(selectedServiceLogPath[0].default_log);
});

// Shifts form to the next step
$('.next-step').on('click', function() {
  $('#serverSelector').fadeOut(500, function() {
    $('header .title').text('Log a new service');
    $('#serviceSelector').fadeIn(500);
    $('#selectedServers').html(formData.services.servers.map(function(server) {
      return "<li class='table-view-cell'>" + server + "</li>";
    }).join(""));
  });
});

function addService(service) {
  var servers = JSON.parse(sessionStorage.getItem('servers'));
  var services = JSON.parse(sessionStorage.getItem('services'));
  var selectedHosts = formData.services.servers;
  // does not check for dupes
  var newService = {
    id: services.length + 100,
    name: service.name,
    service_type: service.service_type,
    log_path: service.log_path,
    servers: servers.filter(function(server) {
      filtered = selectedHosts.filter(function(h) {
        return server.host === h;
      })
      return filtered.length > 0;
    })
  }
  services.push(newService);
  sessionStorage.setItem('services', JSON.stringify(services));

  servers = servers.map(function(server) {
    if (newService.servers.filter(function(s) { return s.id === server.id }).length > 0) {
        server.services.push({
        id: newService.id,
        name: newService.name,
        service_type: newService.service_type,
        log_path: newService.log_path
      });
    }
    return server;
  })
  sessionStorage.setItem('servers', JSON.stringify(servers));
}

// Submits the form
$('#serviceSelector').on('submit', function(e) {
  e.preventDefault();

  formData.services.name = $('#serviceNameInput').val();
  formData.services.service_type = $('#serviceSelector select').val();
  formData.services.log_path = $('#logPathInput').val();

  // Ajax call to POST the new service here
  var username = localStorage.getItem('username');
  var authToken = localStorage.getItem('auth_token');

  addService(formData.services);
  window.location.href = '/#services';
  /*
  $.ajax({
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + btoa(username + ':' + authToken)
    },
    url: '/services',
    data: formData
  }).done(function(resp) {
    window.location.href = '/#services';
  });
  */
});

  </script>

</div>

